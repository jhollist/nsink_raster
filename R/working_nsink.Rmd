---
title: "Draft raster methodology in R"
author:
- Jeff Hollister
- Q Kellogg
date: '2017-11-27'
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---
```{r}
#devtools::install_github("jimhester/archive")
library(here)
library(archive)
library(httr)
library(raster)
library(sp)
library(rgdal)
library(tidyverse)
library(sf)
library(FedData)
```
This is a working script to be used to figure out the raster methodology for
N-Sink.  It will be messy.

# Step 0: Get Data

Eventually front-load data collection, for now do it by task.

# Step 1: Generate flow path from user specified location

## Data
Grab flow direction and 12 Digist HUSCS from NHD Plus

```{r}
# Grab data if doesn't exist locally
if(!file.exists(here("data/nhdplus_ne_fdr.7z"))){
  fdr_url <- "http://www.horizon-systems.com/NHDPlusData/NHDPlusV21/Data/NHDPlusNE/NHDPlusV21_NE_01_01a_FdrFac_01.7z"
  httr::GET(fdr_url, httr::write_disk(path = here("data/nhdplus_ne_fdr.7z")),progress())
  archive_extract(here("data/nhdplus_ne_fdr.7z"), here("data"))
}
if(!file.exists(here("data/nhdplus_ne_huc12.7z"))){
  huc12_url <- "http://www.horizon-systems.com/NHDPlusData/NHDPlusV21/Data/NHDPlusNE/NHDPlusV21_NE_01_WBDSnapshot_03.7z"
  httr::GET(huc12_url, httr::write_disk(here("data/nhdplus_ne_huc12.7z")), httr::progress())
  archive_extract(here("data/nhdplus_ne_huc12.7z"), here("data"))
}
```

NHDPlus available via two-digit HUCS, for individual applications need to pare down to HUC 12 (or 10).

```{r}
fdr_ne <- raster(here("data/NHDPlusNE/NHDPlus01/NHDPlusFdrFac01a/fdr/"))
huc12_ne <- st_read(here("data/NHDPlusNE/NHDPlus01/WBDSnapshot/WBD/WBD_Subwatershed.shp")) %>% st_transform(projection(fdr_ne))
niantic_huc <- huc12_ne %>%
  filter(HU_12_NAME == "Niantic River") 
niantic_fdr <- crop(fdr_ne, as(niantic_huc,"Spatial"))
```

## Calculate the flow path of interest

This can all be done direclty in r with `raster::flowPath()`

```{r}
plot(as(niantic_huc, "Spatial"))
#loc <- unlist(locator(1)) can use this for interactive
loc <- c(1950005,2295977)
example_fp <- flowPath(niantic_fdr, loc)
example_fp_xy <- xyFromCell(niantic_fdr, example_fp)
plot(niantic_fdr)
plot(niantic_huc, add = T)
lines(example_fp_xy)
```

# Step 2: Summarize land, stream, and lake removal 

land removal is a constant made up of pixels that are vegetated Hydric Soils
Combination of hydric soils from SSURGO and Vegetated land cover from NLCD
Figuring this layer(s) out will be the most work.

## Data

### soils:  https://github.com/ncss-tech and soilDB
Soils are complicated...

- https://gdg.sc.egov.usda.gov/GDGHome_DirectDownLoad.aspx
- Can download by state - gives gridded mukey(?)
  - https://nrcs.app.box.com/v/soils/folder/23623124719
  - This is on box.com.  Need to figure way to download from R, but it's big per state.  
- Get hdyric data (yes no) from https://www.nrcs.usda.gov/Internet/FSE_DOCUMENTS/nrcseprd1316619.html
  - currently have for all NE in "data/NRCS State Hydric Soils List.html"
  - need to scrape this html to get table out into a data frame.
- Need to output row and column from gSSURGO that have a match in hydric data frame.  
- Create new raster from those matching row and columns as Hydric.  all other r,c are not hydric.
- Have an example gSSURGO for CT in the data folder
- the zip is in there too.  It was a bit weird and not directly unzippable. The source data and how to extract this needs to be figured out for reproducibilities sake!
    - FedData to the resue!  (maybe)

```{r}
#re-run
ct600_ssurgo <- get_ssurgo(c("CT600"),"ct600","data/ssurgo/ct600","data/ssurgo/ct600")

niantic_ssurgo <- get_ssurgo(as(niantic_huc, "Spatial"), "niantic", "data/ssurgo", "data/ssurgo")



niantic_hydric <- st_as_sf(niantic_ssurgo$spatial) 


%>%
  mutate(mukey = as.numeric(as.character(MUKEY))) %>%
  inner_join(niantic_ssurgo$tabular$component, by = "mukey") %>%
  select(mukey, hydricrating) %>%
  st_transform(proj4string(niantic_fdr))

niantic_hydric_sp <- as(niantic_hydric,"Spatial")
niantic_hydricrating <- niantic_hydric_sp$hydricrating
niantic_hydric_r <- rasterize(niantic_hydric_sp, 
                              niantic_fdr, 
                              1)

```

```{r, eval=FALSE}
if(!file.exists(here("data/gssurgo_ct.gdb"))){
  GET("")
}
# List layers in file geodatabase
rgdal::ogrListLayers(here("/data/gSSURGO_CT.gdb"))
system("ogr2ogr -f CSV component.csv /data/gSSURGO_CT.gdb component")
component <- read_csv(here("data/component.csv"))
system("ogr2ogr -f CSV mapunit.csv gSSURGO_CT.gdb mapunit")
mapunit <- read_csv(here("data/mapunit.csv"))
x <- st_read(here("data/gSSURGO_CT.gdb"), "SAPOLYGON")
# AAAAAAAAAAAAAAAAAAAHHHHHHHHHHH!!!!!!!!
```

For time being use NLCD wetlands class for hydric removal

### NLCD:  https://www.sciencebase.gov/catalog/item/4f70a43ce4b058caae3f8db3 (and zips on S3)

Need to get NLCD from Sciencebase

```{r}
url <- "https://s3-us-west-2.amazonaws.com/prd-tnm/StagedProducts/NLCD/data/2011/landcover/3x3/NLCD2011_LC_N39W072.zip"

# FedData better option
if(!file.exists(here("data/niantic_NLCD_2011_landcover.tif"))){
  niantic_nlcd <- get_nlcd(as(niantic_huc,"Spatial"), label = "niantic", extraction.dir = "data")
}
niantic_nlcd <- raster(here("data/niantic_NLCD_2011_landcover.tif"))
```

### Waterbodies and Streams: NHDPlus

Grab waterbody snapshot for NE from NHD Plus

```{r}
if(!file.exists(here("data/nhdplus_ne_snapshot.7z"))){
  fdr_url <- "http://www.horizon-systems.com/NHDPlusData/NHDPlusV21/Data/NHDPlusNE/NHDPlusV21_NE_01_NHDSnapshot_04.7z"
  httr::GET(fdr_url, httr::write_disk(path = here("data/nhdplus_ne_snapshot.7z")),progress())
  archive_extract(here("data/nhdplus_ne_snapshot.7z"), here("data"))
}
```

Waterbodies are in NHDWaterbodies and flowlines are in NHDFlowlines

```{r}
ne_streams <- st_read(here("data/NHDPlusNE/NHDPlus01/NHDSnapshot/Hydrography/NHDFlowline.shp")) %>%
  st_transform(st_crs(niantic_huc)) %>%
  st_zm
niantic_streams <- ne_streams %>%
  slice(st_contains(niantic_huc, ne_streams)[[1]])
ne_waterbodies <- st_read(here("data/NHDPlusNE/NHDPlus01/NHDSnapshot/Hydrography/NHDWaterbody.shp")) %>%
  st_transform(st_crs(niantic_huc))
niantic_waterbodies <- ne_waterbodies %>%
  slice(st_contains(niantic_huc, ne_waterbodies)[[1]])
```

Velocity estimates also in NHDPlus

Vogel and EROM based.  Ask Q.

\EROMExtension\EROM_MA0001 and EROM_mm0001 (tables) for the EROM ones and
\VogelExtension\VogelFlow (table) which has Vogel Flow and Jobson Velocity.

## Output

What does the output for this look like? Table? Flow path with removal values?  Something else?

Bare minimum is table of removal.  Per segment ideally.

Example output #1 - landcover summary table - Along a 100 m buffer

| Landcover Class | Total Area | 
|-----------------|------------|
| Developed       | XX         |
| Forested        | XX         |
| Wetland         | XX         |
| Other           | XX         |

Example output #2 - Nitrogen removal per segment (drop to integer values)

| Segement Type | Length | Percent Removal | N in | N out |
|---------------|--------|-----------------|------|-------|
| Non-hydric    | 8156   | 0               | 100  | 100   |
| Hydric        | 546    | 80              | 100  | 20    |
| Stream        | XX     | 16              | 20   | 16.8  |
| Lake/Pond     | XX     | 23              | 16.8 | 12.9  |
| Stream        | XX     | 1               | 12.9 | 11.6  |


