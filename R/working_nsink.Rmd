---
title: "Draft raster methodology in R"
author:
- Jeff Hollister
- Q Kellogg
date: '2017-11-27'
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---
```{r}
devtools::install_github("jimhester/archive")
library(here)
library(archive)
library(httr)
library(raster)
library(sp)
library(rgdal)
library(tidyverse)
library(sf)
```
This is a working script to be used to figure out the raster methodology for
N-Sink.  It will be messy.

# Step 0: Get Data

Eventually front-load data collection, for now do it by task.

# Step 1: Generate flow path from user specified location

## Data
Grab flow direction and 12 Digist HUSCS from NHD Plus

```{r}
# Grab data if doesn't exist locally
if(!file.exists(here("data/nhdplus_ne_fdr.7z"))){
  fdr_url <- "http://www.horizon-systems.com/NHDPlusData/NHDPlusV21/Data/NHDPlusNE/NHDPlusV21_NE_01_01a_FdrFac_01.7z"
  httr::GET(fdr_url, httr::write_disk(path = here("data/nhdplus_ne_fdr.7z")),progress())
  archive_extract(here("data/nhdplus_ne_fdr.7z"), here("data"))
}
if(!file.exists(here("data/nhdplus_ne_huc12.7z"))){
  huc12_url <- "http://www.horizon-systems.com/NHDPlusData/NHDPlusV21/Data/NHDPlusNE/NHDPlusV21_NE_01_WBDSnapshot_03.7z"
  httr::GET(huc12_url, httr::write_disk(here("data/nhdplus_ne_huc12.7z")), httr::progress())
  archive_extract(here("data/nhdplus_ne_huc12.7z"), here("data"))
}
```

NHDPlus available via two-digit HUCS, for individual applications need to pare down to HUC 12 (or 10).

```{r}
fdr_ne <- raster(here("data/NHDPlusNE/NHDPlus01/NHDPlusFdrFac01a/fdr/"))
huc12_ne <- st_read(here("data/NHDPlusNE/NHDPlus01/WBDSnapshot/WBD/WBD_Subwatershed.shp")) %>% st_transform(projection(fdr_ne))
niantic_huc <- huc12_ne %>%
  filter(HU_12_NAME == "Niantic River") 
niantic_fdr <- crop(fdr_ne, as(niantic_huc,"Spatial"))
```

## Calculate the flow path of interest

This can all be done direclty in r with `raster::flowPath()`

```{r}
plot(as(niantic_huc, "Spatial"))
#loc <- unlist(locator(1)) can use this for interactive
loc <- c(1950005,2295977)
example_fp <- flowPath(niantic_fdr, loc)
example_fp_xy <- xyFromCell(niantic_fdr, example_fp)
plot(niantic_fdr)
plot(niantic_huc, add = T)
lines(example_fp_xy)
```

# Step 2: Summarize land, stream, and lake removal 

land removal is a constant made up of pixels that are vegetated Hydric Soils
Combination of hydric soils from SSURGO and Vegetated land cover from NLCD
Figuring this layer(s) out will be the most work.

## Data

### soils:  https://github.com/ncss-tech and soilDB
Soils are complicated...

- https://gdg.sc.egov.usda.gov/GDGHome_DirectDownLoad.aspx
- Can download by state - gives gridded mukey(?)
  - https://nrcs.app.box.com/v/soils/folder/23623124719
- Get hdyric data (yes no) from https://www.nrcs.usda.gov/Internet/FSE_DOCUMENTS/nrcseprd1316619.html
  - currently have for all NE in "data/NRCS State Hydric Soils List.html"
  - need to scrape this html to get table out into a data frame.
- Need to output row and column from gSSURGO that have a match in hydric data frame.  
- Create new raster from those matching row and columns as Hydric.  all other r,c are not hydric.

### NLCD:  https://www.sciencebase.gov/catalog/item/4f70a43ce4b058caae3f8db3 (and zips on S3)

### Waterbodies and Streams: NHDPlus

Grab waterbody snapshot for NE from NHD Plus

```{r}
if(!file.exists(here("data/nhdplus_ne_snapshot.7z"))){
  fdr_url <- "http://www.horizon-systems.com/NHDPlusData/NHDPlusV21/Data/NHDPlusNE/NHDPlusV21_NE_01_NHDSnapshot_04.7z"
  httr::GET(fdr_url, httr::write_disk(path = here("data/nhdplus_ne_snapshot.7z")),progress())
  archive_extract(here("data/nhdplus_ne_snapshot.7z"), here("data"))
}
```

Waterbodies are in NHDWaterbodies and flowlines are in NHDFlowlines

```{r}
streams_ne <- st_read(here())
waterbodies_ne <- st_read(here())
```

## Output

What does the output for this look like? Table? Flow path with removal values?  Something else?

Bare minimum is table of removal.  Per segment ideally.

Example output #1 - landcover summary table - Along a 100 m buffer

| Landcover Class | Total Area | 
|-----------------|------------|
| Developed       | XX         |
| Forested        | XX         |
| Wetland         | XX         |
| Other           | XX         |

Example output #2 - Nitrogen removal per segment (drop to integer values)

| Segement Type | Length | Percent Removal | N in | N out |
|---------------|--------|-----------------|------|-------|
| Non-hydric    | 8156   | 0               | 100  | 100   |
| Hydric        | 546    | 80              | 100  | 20    |
| Stream        | XX     | 16              | 20   | 16.8  |
| Lake/Pond     | XX     | 23              | 16.8 | 12.9  |
| Stream        | XX     | 1               | 12.9 | 11.6  |


